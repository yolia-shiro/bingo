var gnum=[],price=[],num=0,sumprice=0;function buy(){var c=0;var a=[];var b=JSON.parse(localStorage.getItem("shoppingcar"));var j=0,e=b.length,f="";var d=new Date();let oid="";var h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz012345678";var s=Math.random()*57;var q=Math.random()*57;var n=Math.random()*57;var m=Math.random()*57;var l=Math.random()*57;let temp6=Math.random()*57;let temp7=Math.random()*57;let temp8=Math.random()*57;let temp9=Math.random()*57;let temp10=Math.random()*57;oid+=h.charAt(s)+h.charAt(q)+h.charAt(n)+h.charAt(m)+h.charAt(l)+h.charAt(temp6)+h.charAt(temp7)+h.charAt(temp8)+h.charAt(temp9)+h.charAt(temp10);console.log("生成的oid为: "+oid);for(;j<e;j++){if((JSON.parse(localStorage.getItem("shoppingcar")))[j]==null){}else{c=1;console.log("i为:"+j);console.log("购买数量为:"+gnum[j]);var k=0,o=[];for(;k<gnum[j];k++){var r="";s=Math.random()*57;q=Math.random()*57;n=Math.random()*57;m=Math.random()*57;l=Math.random()*57;r+=h.charAt(s)+h.charAt(q)+h.charAt(n)+h.charAt(m)+h.charAt(l);o.push(r)}console.log("生成的keylist为: "+o);a.push(b[j].gid);var g={oid:oid,uid:userInfo.uid,gid:b[j].gid,knum:gnum[j],klist:JSON.stringify(o),discount:b[j].discount,otime:d};console.log("订单详情\n oid:"+g.oid+"\n uid:"+g.uid+"\n gid:"+g.gid+"\n knum:"+g.knum+"\n klist:"+g.klist+"\n discount:"+g.discount+"\n otime:"+g.otime);$.post("store/insertOrderDetail",g,function(i){console.log(i)});console.log("gids: "+a)}}if(c==0){alert("购物车为空，快去添加自己喜欢的游戏吧~~~");return}console.log("当前用户ID:"+userInfo.uid);var p={uid:userInfo.uid,gid:JSON.stringify(a),mode:1};$.post("/person/updateGameListById",p,function(i){console.log(i)});window.alert("购买成功！")}function pricesum(a){console.log("更前后的数量:"+gnum[$(a).attr("id")]);sumprice+=($(a).val()-gnum[$(a).attr("id")])*price[$(a).attr("id")];gnum[$(a).attr("id")]=parseInt($(a).val());console.log("更改后的数量:"+gnum[$(a).attr("id")]);console.log("单价:"+gnum[$(a).attr("id")]);$("#sumprice").text(sumprice)}var templateDiv=$("#choose1");$(".close").click(function(){templateDiv.removeClass("active");templateDiv.addClass("close");$(this).removeClass("close");$(this).addClass("active");templateDiv=$(this);console.log(templateDiv)});function deleteCar(a){var e=$(a).attr("id");var b=JSON.parse(localStorage.getItem("shoppingcar"));var c=0,d=b.length;for(;c<d;c++){if(JSON.parse(b[c]==null)){b.splice(c,1)}else{if(e==b[c].gid){b.splice(c,1);break}}}localStorage.setItem("shoppingcar",JSON.stringify(b));window.alert("删除商品成功！");window.location.reload()}function addWishList(a){var c=$(a).attr("id");console.log("游戏ID:"+c);var b={uid:userInfo.uid};$.get("/person/getUserById",b,function(d){console.log(d);wishlist=d.resultMap.wishList;console.log(wishlist);if(wishlist===null){}else{var e=0,g=wishlist.length,f=0;for(;e<g;e++){if(c==wishlist[e].gid){f=1;break}}}if(f==1){window.alert("已在心愿单中！请勿重复添加")}else{var h={uid:userInfo.uid,gid:c,mode:1};$.post("/person/updateWishListById",h,function(i){console.log(i)});window.alert("加入心愿单成功！")}})}$(document).ready(function(){function a(){if(localStorage.getItem("shoppingcar")==null||((JSON.parse(localStorage.getItem("shoppingcar")))[0]==null&&(JSON.parse(localStorage.getItem("shoppingcar")))[1]==null)){}var b=JSON.parse(localStorage.getItem("shoppingcar"));var d=0,e=b.length,c="";for(;d<e;d++){if((JSON.parse(localStorage.getItem("shoppingcar")))[d]==null){}else{gnum[d]=1;price[d]=b[d].price*b[d].discount;console.log("读取购物车");console.log(b[d]);c+='<div class="myorder-elem">\n                <span class="column1">\n                    <span class="game-title" id="1-1">\n                        <img class="column1-img" src='+b[d].chref+'id="">\n                        <span class="column1-txt">'+b[d].gname+'</span>\n                    </span>\n                </span>\n                <div class="price" id="">￥'+b[d].price*b[d].discount+'</div>\n                <div class="row3" id="">\n                    <input type="number" step=\'1\'  onchange=\'pricesum(this)\'  class="num" id='+d+' onkeydown="return false;" max="10" min="1" value="1">                </div>\n<div class="operate">\n                    <div class="sum1"><button class="da btn-secondary" onclick=\'deleteCar(this) \'id='+b[d].gid+'>删除</button></div>\n                    <div class="sum1"><button class="da btn-info" onclick=\'addWishList(this)\' id='+b[d].gid+">加入心愿单</button></div>\n                </div></div>";num++;sumprice+=b[d].price*b[d].discount}}$("#order-main").append(c);$("#num").text(num);$("#sumprice").text(sumprice)}$("#choose1").removeClass("close");$("#choose1").addClass("active");a()});