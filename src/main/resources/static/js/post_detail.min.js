var loc=location.href;var n1=loc.length;var n2=loc.indexOf("=");var POSTID=decodeURI(loc.substr(n2+1,n1-n2));function change(){txt=$("#content-txt").val();var a=150-txt.length;document.getElementById("limit").innerText=a}function addComment(){var a=$("#content-txt").val();if(a.length==0){alert("评论内容不可以为空！")}else{var b=new Date();console.log(b);var c={uid:userInfo.uid,pid:POSTID,content:a,ctime:b,ctype:0,tocid:-1,touid:-1};$.post("/community/addComment",c,function(d){})}window.location.reload()}function Reply1(d){var a=window.prompt("输入回复内容");if(a.length==0){alert("评论内容不可以为空！")}else{var b=new Date();console.log(b);console.log("postid",POSTID);var c={uid:userInfo.uid,pid:POSTID,content:a,ctime:b,ctype:1,tocid:$(d).attr("id"),touid:-1};$.post("/community/addComment",c,function(e){})}window.location.reload()}function Reply2(d){var a=window.prompt("输入回复内容");if(a.length==0){alert("评论内容不可以为空！")}else{var b=new Date();console.log(b);var c={uid:userInfo.uid,pid:POSTID,content:a,ctime:b,ctype:1,tocid:$(d).attr("id"),touid:$(d).attr("name")};console.log("发送的数据tocid"+c.tocid+" touid"+c.touid);$.post("/community/addComment",c,function(e){})}window.location.reload()}$(document).ready(function(){function c(e){let postData={idType:"pid",idValue:parseInt(e)}$.ajax({url:"community/getPostsById",data:postData,type:"get",async:false,success:function(f){thisPost=f.resultMap.postBypid}});let commentData={idType:"pid",idValue:e}$.ajax({url:"community/getCommentsById",data:commentData,type:"get",async:false,success:function(f){postReply=f.resultMap.CommentBypid.length}});d()}function d(){$(".post-theme").text("【"+thisPost[0].ptheme+"】"+thisPost[0].title);$(".post-date").text("发表于"+thisPost[0].ptime);$(".repost").text("点赞"+thisPost[0].plikenum);$(".views").text("评论"+postReply);$(".content").text(thisPost[0].content);$(".up-count").text(thisPost[0].plikenum)}function a(){if(userInfo.uid===undefined){return}else{var f={uid:userInfo.uid};$.get("/person/getUserById",f,function(g){console.log(g);var h=g.resultMap.user;document.getElementById("user-Avatar").src=h.uavatar});$("#user-Avatar").show();$(".textarea-block-wrapper").css("width","90%");var e="";e+='<textarea style="width: 100%"  id="content-txt" maxlength="150" oninput="change()">输入评论内容</textarea>';$("#textarea-block").html(e)}}function b(){var e={idType:"pid",idValue:POSTID};$.get("/community/getCommentsById",e,function(f){var l=f.resultMap.CommentBypid;console.log(l);if(l===undefined){return}var k="",h=l.length,g=1;for(;g<=h;g++){if(l[g-1].ctype==0){var m={uid:l[g-1].uid};$.ajax({url:"/person/getUserById",data:m,type:"get",async:false,success:function(i){k+='<div class="community-talk-item" >\n                        <div class="avatar-wrapper">\n                            <a target="_blank" href="other_profile.html?uid='+l[g-1].uid+'">\n';k+="<img src="+i.resultMap.user.uavatar+'>\n                            </a>\n                        </div>\n                        <div class="comment-content" id=F'+l[g-1].cid+'>\n                            <div class="user-name">\n                                <a target="_blank" href="other_profile.html?uid='+l[g-1].uid+'">'+i.resultMap.user.ualias+"</a>\n";k+="<span>发表于"+l[g-1].ctime.substr(0,19)+'</span>\n                            </div>\n                            <div class="content">'+l[g-1].content+'</div>\n                            <div class="action">\n                                <button class="reply" id='+l[g-1].cid+" name="+l[g-1].uid+" onclick=Reply1(this)>回复</button>\n                            </div>\n                        </div>\n                    </div>"}})}}$("#content").append(k);h=l.length,g=1;for(;g<=h;g++){if(l[g-1].ctype==1){if(l[g-1].touid==-1){k="";var m={uid:l[g-1].uid};$.ajax({url:"/person/getUserById",data:m,type:"get",async:false,success:function(i){k+='<div class="community-talk-item-child">\n                            <div class="avatar-wrapper">\n                                <a target="_blank" href="other_profile.html?uid='+l[g-1].uid+'">\n<img src='+i.resultMap.user.uavatar+'>\n                                </a>\n                            </div>\n                            <div class="comment-content">\n                                <div class="user-name">\n                                    <a target="_blank" href="other_profile.html?uid='+l[g-1].uid+'">'+i.resultMap.user.ualias+':</a>                                    <span class="content">'+l[g-1].content+'</span>\n                                </div>\n                                <div class="action">\n                                    <span>发表于'+l[g-1].ctime.substr(0,19)+'</span>\n                                    <button class="reply" id='+l[g-1].tocid+" name="+l[g-1].uid+" onclick='Reply2(this)'>回复</button>\n                                </div>\n                            </div>\n                        </div>"}});var n="#F"+l[g-1].tocid;$(n).append(k)}else{k="";var m={uid:l[g-1].uid};$.ajax({url:"/person/getUserById",data:m,type:"get",async:false,success:function(j){k+='<div class="community-talk-item-child">\n                            <div class="avatar-wrapper">\n                                <a target="_blank" href="other_profile.html?uid='+l[g-1].uid+'">\n<img src='+j.resultMap.user.uavatar+'>\n                                </a>\n                            </div>\n                            <div class="comment-content">\n                                <div class="user-name">\n                                    <a target="_blank" href="other_profile.html?uid='+l[g-1].uid+'">'+j.resultMap.user.ualias+':</a>                                    <span class="content">回复@';var i={uid:l[g-1].touid};$.ajax({url:"/person/getUserById",data:i,type:"get",async:false,success:function(o){k+=o.resultMap.user.ualias+":"}});k+=l[g-1].content+'</span>\n                                </div>\n                                <div class="action">\n                                    <span>发表于'+l[g-1].ctime.substr(0,19)+'</span>\n                                    <button class="reply" id='+l[g-1].tocid+" name="+l[g-1].uid+" onclick='Reply2(this)'>回复</button>\n                                </div>\n                            </div>\n                        </div>"}});var n="#F"+l[g-1].tocid;$(n).append(k)}}}})}c(POSTID);a();b();change()});function thumb_up(){if(userInfo.uid===undefined){myAlert("请登录后进行操作!");return}thisPost[0].plikenum=$(".up-count").text();let upFormData=new FormData();upFormData.append("pid",parseInt(POSTID));upFormData.append("propName","plikenum");let postValue=Number(thisPost[0].plikenum)+1;upFormData.append("propValue",postValue);JSON.stringify(upFormData);$.ajax({url:"/community/updatePostProp",data:upFormData,type:"post",processData:false,contentType:false,cache:false,async:true,success:function(a){$(".up-count").text(parseInt($(".up-count").text())+1);console.log($(".up-count").text());$(".repost").text("点赞"+parseInt($(".up-count").text()))}})}function to_user_login(){$("nav.navbar ul.navbar-right:eq(1) > li:first-of-type > a").click()};